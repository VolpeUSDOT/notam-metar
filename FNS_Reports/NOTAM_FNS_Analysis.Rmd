---
title: 'NOTAM Frequency Analysis - 2020'
output:
  html_document:
    fig_caption: true
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- Add the following line manually to the rendered HTML document so that IE does not block the javascript elements: -->
<!-- saved from url=(0014)about:internet --> 

Goals: 

- Produce visuals of NOTAM frequencies by date, with data downloaded from FNS Reports site
- Filter out NOTAMS within 10 minutes of the same ID
- Frequency distributions of counts of NOTAMs by date



```{r setup, echo = F, message=F}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(plotly)    # for interactive plots
library(kableExtra)# for better tables

# Working directory: This sets the path to my H: drive if being run from my computer, otherwise put in your own path
workingdir <- file.path(getwd(), 'Data/NOTAMS')

# knitr::opts_knit$set(root.dir = workingdir)

```

```{r compile}
# Loop over reports and compile

if(!file.exists('FNS_NOTMAS.RData')){

  files_to_read = dir(workingdir)
  
  compiled = vector()
  
  for(f in files_to_read){
    fx <- read.csv(file.path(workingdir, f))
    compiled = rbind(compiled, fx)
    cat('. ')
  }
  
  # format date-time
  compiled <- compiled %>%
    mutate(Start.Date.UTC = strptime(Start.Date.UTC, format = '%m/%d/%Y %H%M', tz = 'UTC'),
           End.Date.UTC = strptime(End.Date.UTC, format = '%m/%d/%Y %H%M', tz = 'UTC'),
           Action.Date = strptime(Action.Date, format = '%m/%d/%Y %H%M', tz = 'UTC'),
           Cancellation.Date = strptime(Cancellation.Date, format = '%m/%d/%Y %H%M', tz = 'UTC'))
  
  # Order by Reference.ID and omit any duplicates with Action.Date within 10 minutes
  d <- compiled[order(compiled$Reference.ID, compiled$Action.Date),]
  
  # save(d, file = 'FNS_NOTMAS.RData')
  
  dt <- d %>%
    group_by(Reference.ID) %>%
    mutate(action_time_diff = as.numeric(Action.Date-lag(Action.Date), units = 'mins')) %>%
    ungroup() %>%
    filter(action_time_diff >= 10 | is.na(action_time_diff))
  
  View(dt %>% select(Reference.ID, Action.Date, action_time_diff))
  
} else {
  load('FNS_NOTMAS.RData')
}
```

The orgi data set contains `r nrow(d)` NOTMAS, from `r min(d$Action.Date)` to `r max(d$Action.Date)` with `r format(unique(d$Reference.ID), big.mark = ',')` unique NOTAM Reference IDs.

After removing NOTAMS within 10 minutes of each other (for the same Reference ID), the remaining full set of NOTAMS is `r format(unique(dt$Reference.ID), big.mark = ',')`.

```{r format}

# Season: First define months from date time, then manually code months into seasons with a series of if/else statements nested together.

if(!file.exists('FNS_NOTMAS.RData')){
  df <- dt %>% 
    mutate(dow = format(Action.Date, '%A')) %>%
    mutate(date = as.Date(Action.Date)) %>%
    mutate(year = format(Action.Date, '%Y')) %>%
    mutate(weekend = as.factor(ifelse(dow == 'Saturday' | dow == 'Sunday', 1, 0)),
           quarter = as.factor(quarters(Action.Date)),
           month   = format(Action.Date, '%m'),
           season  = as.factor(ifelse(month == '12' | month == '01' | month == '02', 'Winter',
                                      ifelse(month == '03' | month == '04' | month == '05', 'Spring',
                                             ifelse(month == '06' | month == '07' | month == '08', 'Summer',
                                                    ifelse(month == '09' | month == '10' | month == '11', 'Fall', NA)))))) %>% 
      group_by(FPA, date, year, month, season, weekend) %>% 
    summarize(count = n())
  
  write.csv(df, file = 'FNS_NOTAM_count_by_day.csv', row.names=F)
  
  
  save(list = c('d', 'dt', 'df'), file = 'FNS_NOTMAS.RData')
}
```


## Plotting


### Count of NOTAMs by date

```{r dateplot, warning=FALSE}

g1 <- ggplot(df, aes(x = date, y = count)) +
  geom_point(color = scales::alpha('midnightblue', 0.2)) +          # Make semi-transparent points
  geom_smooth(span = 0.1) +                                         # Add a spline through these
  theme_bw() +                                                      # Use a cleaner black and white theme
  ylab("NOTAM counts") + xlab('Date') +
  ggtitle("Count of NOTAMs by date over the study period")          # Add a title to the plot

ggsave(plot = g1, filename = "NOTAM_Freq_timeline.jpg", width = 6, height = 5) # Save the figure to the working directory

ggplotly(g1)

```

Same data, but now separate lines for weekend and weekday:


```{r dateplot2, warning=FALSE}
# Rename the weekend variable values 
we.labs = c("Weekday", "Weekend") # 0 = *weekday*, see logic in the formatting above
levels(df$weekend) = we.labs

g1.1 <- ggplot(df, aes(x = date, y = count, color = weekend)) +
  geom_point(alpha = 0.1) +          
  geom_smooth(span = 0.1) +                                         # Add a spline through these
  theme_bw() + 
  scale_color_discrete(name = "Day of Week") +                        
  ylab("NOTAM counts") + xlab('Date') +
  ggtitle("Count of NOTAMs by date over the study period \n Separating by weekend ")    

ggsave(plot = g1.1, filename = "NOTAM_Freq_timeline_we.jpg", width = 6, height = 5) 

ggplotly(g1.1)

```

### 2. Histograms by season + weekend/weekday

This figure shows the distribution of the count of NOTAMs by date. Each bar represents a range of NOTAM counts, and the height of bar indicates number of days with that many NOTAMs. The vertical colored lines indicate the mean count of NOTAMs for that combination of season and weekend/weekday. 

```{r hists}

# Make data frame of mean values
df_mc <- df %>%
  group_by(season, weekend) %>%
  summarize(mean_count = mean(count))

g2 <- ggplot(df, aes(count, fill = weekend, group = weekend)) +      # Within panels, group by weekend
  geom_histogram(color = "grey20",                                   # Create histograms
                 bins = 50) +
  geom_vline(aes(xintercept = mean_count,
                 color = weekend), data = df_mc) +
  facet_wrap(~season) +                                              # Make this a multi-panel figure by season
  scale_fill_discrete(name = "Day of Week") +                        # Set the name for the legend
  guides(color = FALSE) +                                            # Suppress legend for vertical lines
  theme_bw() +
  ylab("Count of days") + xlab("Count of NOTAMs") +
  ggtitle("Histograms of NOTAM counts by day")

# Add annotations for each vertical line
df_mc <- df_mc %>%
  mutate(y = 30,
         x = mean_count)

g3 = g2 + geom_text(data = df_mc, 
               mapping = aes(x = x, y = y, 
                             label = round(mean_count, 0),
                             color = weekend),
               size = 3,
               hjust = 1); g3

ggsave(plot = g3, filename = "NOTAM_Freq_histograms.jpg", width = 6, height = 5)            

```



```{r hists_FPA}

pdf('FPA_NOTAM_hists.pdf', width = 8, height = 8)

for(x in unique(d$FPA)){
  
  df_x = df %>% filter(FPA == x)
  
  # Make data frame of mean values
  df_mc <- df_x %>%
    group_by(season, weekend) %>%
    summarize(mean_count = mean(count))
  
  g2 <- ggplot(df_x, aes(count, fill = weekend, group = weekend)) +      # Within panels, group by weekend
    geom_histogram(color = "grey20",                                   # Create histograms
                   bins = 50) +
    geom_vline(aes(xintercept = mean_count,
                   color = weekend), data = df_mc) +
    facet_wrap(~season) +                                              # Make this a multi-panel figure by season
    scale_fill_discrete(name = "Day of Week") +                        # Set the name for the legend
    guides(color = FALSE) +                                            # Suppress legend for vertical lines
    theme_bw() +
    ylab("Count of days") + xlab("Count of NOTAMs") +
    ggtitle(paste0(x, ": Histograms of NOTAM counts by day"))
  
  # Add annotations for each vertical line
  df_mc <- df_mc %>%
    mutate(y = 30,
           x = mean_count)
  
  g3 = g2 + geom_text(data = df_mc, 
                 mapping = aes(x = x, y = y, 
                               label = round(mean_count, 0),
                               color = weekend),
                 size = 3,
                 hjust = 1)
  
  print(g3)

}

dev.off()

```


```{r hists_FPA_grouped}

# Group by W, C, E
fpa_groups <- readxl::read_xlsx(file.path(getwd(), 'Data', 'FPA_Regions.xlsx'))

df_Region = left_join(df, fpa_groups, by = 'FPA') %>%
  group_by(Region, date, year, month, season, weekend) %>%
  summarize(count = sum(count))


pdf('FPA_Grouped_NOTAM_hists.pdf', width = 8, height = 8)

for(x in unique(df_Region$Region)){
  
  df_x = df_Region %>% filter(Region == x)
  
  # Make data frame of mean values
  df_mc <- df_x %>%
    group_by(season, weekend) %>%
    summarize(mean_count = mean(count))
  
  g2 <- ggplot(df_x, aes(count, fill = weekend, group = weekend)) +      # Within panels, group by weekend
    geom_histogram(color = "grey20",                                   # Create histograms
                   bins = 50) +
    geom_vline(aes(xintercept = mean_count,
                   color = weekend), data = df_mc) +
    facet_wrap(~season) +                                              # Make this a multi-panel figure by season
    scale_fill_discrete(name = "Day of Week") +                        # Set the name for the legend
    guides(color = FALSE) +                                            # Suppress legend for vertical lines
    theme_bw() +
    ylab("Count of days") + xlab("Count of NOTAMs") +
    ggtitle(paste0(x, ": Histograms of NOTAM counts by day"))
  
  # Add annotations for each vertical line
  df_mc <- df_mc %>%
    mutate(y = 30,
           x = mean_count)
  
  g3 = g2 + geom_text(data = df_mc, 
                 mapping = aes(x = x, y = y, 
                               label = round(mean_count, 0),
                               color = weekend),
                 size = 3,
                 hjust = 1)
  
  print(g3)

}

dev.off()

```

